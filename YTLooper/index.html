<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <style>
        #player {
            display: block;
            margin: 5px auto;
        }
        #app {
            display: block;
            margin: 0 auto;
            width: 620px;
        }
        #inputs {
            display: grid;
            grid-template-areas:    "videoL startL startL endL endL .   .     buttB buttP buttTV"
                                    "videoI startI startB endI endB .   buttR .     .     .     ";
            grid-template-columns:   1fr    1fr    1fr    1fr  1fr  5px 2fr   1fr   1fr 3fr;
            grid-column-gap: 5px;
            grid-template-rows: 24px 20px;
            grid-row-gap: 5px;
            padding-bottom: 15px;
        }
        #videoIdLabel {
            grid-area: videoL;
        }
        #videoId {
            width: 14ch;
            grid-area: videoI;
        }
        #startLabel {
            grid-area: startL;
        }
        #start {
            grid-area: startI;
        }
        #setStart {
            width: 5ch;
            grid-area: startB;
        }
        #endLabel {
            grid-area: endL;
        }
        #end {
            grid-area: endI;
        }
        #setEnd {
            width: 5ch;
            grid-area: endB;
        }
        #restart {
            grid-area: buttB;
            padding: 0;
        }
        #pause {
            grid-area: buttP;
            padding: 0;
        }
        #reset {
            grid-area: buttR;
        }
        #toggleVideo {
            grid-area: buttTV;
        }
        input[type=number] {
            width: 8ch;
        }
        #videoIdLabel, #startLabel, #endLabel {
            padding-top: 10px;
        }
        #shareUrl {
            width: 620px;
        }
        .hidden {
            display: none !important;
        }
    </style>
    <title>YouTube Looper</title>
</head>
<body>
    <!-- Embedded YouTube will replace this div -->
    <div id="player"></div>

    <!-- Vue app -->
    <div id="app">
        <div id="inputs">
            <label id="videoIdLabel" for="videoId">Video ID</label>
            <input id="videoId" type="text" v-model.lazy="videoId" v-on:change="videoChange" title="Paste YouTube video link or ID" onclick="this.select()">

            <label id="startLabel" for="start">Start</label>
            <input id="start" type="number" v-model.number="start" step=0.1>
            <button id="setStart" title="Set loop start to current position in video">Set</button>

            <label id="endLabel" for="end">End</label>
            <input id="end" type="number" v-model.number="end" step=0.1>
            <button id="setEnd" title="Set loop end to current position in video">Set</button>

            <button id="restart" title="Go back to beginning of the loop">
                <img src="backarrow.svg" alt="Back arrow" height="20px" width="20px" />
            </button>
            <button id="pause" title="Pause/Play video">
                <img src="playpause.svg" alt="Play/Pause" height="20px" width="20px" />
            </button>
            <button id="reset" title="Reset loop start and end to 0">Reset</button>

            <button id="toggleVideo">Toggle video</button>
        </div>
        <div id="share">
            <label for="shareUrl">Share</label>
            <input id="shareUrl" type="text" :value="shareUrl" onclick="this.select()">
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/vue"></script>
    <script src="https://youtube.com/iframe_api"></script>
    <script>
        var url = new URL(window.location.href);
        var ytregex = /(?:youtube(?:-nocookie)?\.com\/(?:[^\/\n\s]+\/\S+\/|(?:v|e(?:mbed)?)\/|\S*?[?&]v=)|youtu\.be\/)([a-zA-Z0-9_-]{11})/;
        var player;

        var app = new Vue({
            el: "#app",
            data: {
                baseUrl: window.location.href.match(/^[^\#\?]+/)[0].replace(/\/$/, ""),
                start:  Number(url.searchParams.get("start")),
                end: Number(url.searchParams.get("end")),
                videoId: url.searchParams.get("v"),
            },
            watch: {
                shareUrl: debounce(updateAddressBar, 1000)
            },
            computed: {
                urlParams: function () {
                    var urlParamsString = "?v="+this.videoId;
                    if (this.start > 0) { urlParamsString += "&start="+this.start }
                    if (this.end > this.start) { urlParamsString += "&end="+this.end }
                    return urlParamsString;
                },
                shareUrl: function () {
                    return this.baseUrl + this.urlParams;
                }
            },
            methods: {
                videoChange: function () {
                    var ytLink = this.videoId.match(ytregex);
                    if (ytLink) {
                        this.videoId = ytLink[1];
                    }
                    player.loadVideoById(this.videoId, this.start);
                } 
            }
        })

        function onYouTubeIframeAPIReady() {
            player = new YT.Player("player", {
                height: "390",
                width:  "640",
                videoId: app.videoId,
                events: {
                    "onReady": onPlayerReady,
                    "onStateChange": function(e) {
                        var status = e.data;
                        if (status === YT.PlayerState.ENDED) {
                            player.seekTo(app.start);
                        }
                    }
                }
            })
        }

        function onPlayerReady(e) {
            e.target.seekTo(app.start);
            e.target.playVideo();
            setInterval(function() {
                if (app.end > app.start && player.getCurrentTime() > app.end) {
                    player.seekTo(app.start);
                };
            }, 25);
        }

        function updateAddressBar() {
            // Only works in HTML5
            history.pushState(
                {start: app.start, end: app.end, videoId: app.videoId},
                "YouTube Looper",
                app.urlParams
            )
        }

        // creates a function that only invokes f when it has gone
        // <wait> milliseconds without being called
        function debounce(f, wait) {
            var timer;
            return function () {
                var later = function() {
                    f.apply(this);
                }
                clearTimeout(timer)
                timer = setTimeout(later, wait);
            }
        }

        document.getElementById("setStart").addEventListener("click", function(e) {
            app.start = Math.round(player.getCurrentTime()*100)/100;
        });
        document.getElementById("setEnd").addEventListener("click", function(e) {
            app.end = Math.round(player.getCurrentTime()*100)/100;
        });
        document.getElementById("restart").addEventListener("click", function(e) {
            player.seekTo(app.start);
        })
        document.getElementById("reset").addEventListener("click", function(e) {
            app.start = 0;
            app.end = 0;
        });
        document.getElementById("pause").addEventListener("click", function(e) {
            player.getPlayerState() === YT.PlayerState.PAUSED ? player.playVideo() : player.pauseVideo();
        });
        document.getElementById("toggleVideo").addEventListener("click", function(e) {
            document.getElementById("player").classList.toggle("hidden");
        });
        window.onpopstate = function(event) {
            // Handle the browser's "back" button
            if (event.state === null) { return }
            app.start = event.state.start;
            app.end   = event.state.end;
            if (app.videoId !== event.state.videoId) {
                app.videoId = event.state.videoId;
                player.loadVideoById(app.videoId, app.start);
            }
        };

    </script>
</body>
</html>